  name: "CI"
  on:
    pull_request:
      branches:
        - main
    push:
      branches:
        - main
    release:
      types:
        - published
  jobs:
    tests:
      runs-on: ${{ matrix.os}}-latest
      name: "üíª-${{matrix.os }} üêç-${{ matrix.python-version }}"
      strategy:
        fail-fast: false
        matrix:
          os: ["ubuntu", "macos"]
          python-version:
            - "3.9"
      steps:
        - uses: actions/checkout@v4
        - name: "Setup Micromamba"
          uses: mamba-org/provision-with-micromamba@main
          with:
            environment-file: environment.yml
            environment-name: openfe_analysis_env
            cache-env: true
            cache-downloads: true
            extra-specs: |
              python==${{ matrix.python-version }}
        - name: "Environment Information"
          run: |
            micromamba info
            micromamba list
        - name: "Install"
          run: |
            python -m pip install --no-deps .
        - name: "Test imports"
          run: |
            python -Ic "import openfe_analysis; print(openfe_analysis.__version__)"
        - name: "Run tests"
          run: |
            pytest -n auto -v --cov=openfe_analysis --cov-report=xml --durations=10
        - name: codecov
          if: ${{ github.repository == 'OpenFreeEnergy/openfe_analysis'
                 && github.event_name == 'pull_request' }}
          uses: codecov/codecov-action@v3
          with:
            token: ${{ secrets.CODECOV_TOKEN }}
            file: coverage.xml
            fail_ci_if_error: false
            verbose: true
